
### 想定される通信モデル

* **通信方式:** マルチキャスト（またはブロードキャスト）
    * プローブパケットは、自身のサブネット内のすべての隣接ノード（Peer）に送信されると想定します。
* **通信内容:** プローブパケット (Advertise Message)
    * ノードのID、メトリクス（帯域幅、RTT、ホップ数など）、グループ情報が含まれます。
* **周期:** 5秒に1回
* **目標:** 1,000端末が安定して動作するための**ネットワークの総負荷**を推定します。

---
プローブパケットによる帯域幅の分析（IPv6想定、5秒周期）

1. プローブパケットのデータサイズ推定（IPv6反映）

ご要望に基づき、IPアドレスをIPv6サイズに更新します。プローブパケット（アドバタイズメント）には、少なくともノードの識別情報とトポロジー管理に必要なメトリクスが含まれます。

| 項目 | データサイズ（概算） | 備考 |
| Node ID | 16 bytes | UUIDなど |
| IP Address | 16 bytes | IPv6想定 (+12 bytes) |
| Group ID | 16 bytes | グループ識別子 |
| Metrics | 60 bytes | RTT (制御・アプリ)、帯域幅、安定性、ホップ数など |
| オーバーヘッド | 50 bytes | UDP/IPヘッダ、ペイロードヘッダ |
| 合計 | 約 142 bytes | (旧: 130 bytes) |

仮定: 1プローブパケットのサイズ $\approx 142 \text{ Bytes}$

2. ネットワークの総通信量（総負荷）の計算モデル

ネットワーク全体の通信量 $B_\text{Total}$ は、以下の要素で計算されます。

$$\text{B}_{\text{Total}} = \text{端末数} \times \text{プローブ周期} \times \text{プローブパケットサイズ}$$

(1) 4端末の環境 (小規模ネットワーク)

4端末がすべて同じリンク内に存在し、それぞれが5秒に1回マルチキャストプローブパケットを送信すると仮定します。

1端末あたりの送信通信量 ($B_{1}$):

B_{1} = 142 \text{ Bytes} \times \frac{1 \text{ packet}}{5 \text{ sec}} \times 8 \text{ bits/byte} \approx 227.2 \text{ bps}

ネットワーク全体の総通信量 ($B_{4}$):

送信負荷: 端末数 $N$ が送信するプローブパケットの総量。

\text{B}_{\text{Total}} = 4 \text{ 端末} \times 227.2 \text{ bps} \approx 908.8 \text{ bps}

この規模では、総負荷は約 0.9 Kbps となり、極めて軽微です。

(2) 1,000端末の環境 (大規模ネットワーク)

1,000端末すべてが同一のリンク（IPv6の/64サブネットなど）内に存在し、それぞれが5秒に1回プローブパケットを送信すると仮定します。

ネットワーク全体の総通信量 ($B_{1000}$):

\text{B}_{1000} = 1,000 \text{ 端末} \times 227.2 \text{ bps} \approx 227,200 \text{ bps}

\text{B}_{1000} \approx 227.2 \text{ Kbps}

IPv6アドレスサイズを考慮しても、総負荷はわずか 227.2 Kbps であり、一般的なネットワーク帯域（1 Gbpsなど）に対しては無視できるレベルの負荷です。

3. IPv6環境における重要な考察点

IPv6を採用したことで、ブロードキャスト（ARPなど）に起因する問題は回避され、リンクローカルマルチキャスト（例: ff02::1）が使用されるため、プローブパケットはルーターを越えず、ネットワークのセグメント化の恩恵を自動的に受けられます。しかし、同一リンク内での以下の問題は依然として存在します。

考察 1: 端末あたりの処理負荷（CPU/メモリ）がボトルネック

帯域幅が問題とならない一方で、各端末は5秒ごとに**999個のプローブパケット（他999端末分）**を受信し、処理する必要があります。

パケットの受信とデコード: 5秒間に $1,000 / 5 = 200$ パケット/秒を受信します。

PeerStateの更新: 1,000ノード分のトポロジーテーブルを常に更新し、生存時間（TTL）を管理します。

ロジック処理: 親ノードの選定やメトリクス計算など、ノード数 $N$ に対して $O(N)$ で増大する処理をすべてのノードが実行します。

これにより、特に低スペックなノードではCPU負荷とメモリ消費が極めて高くなり、システム全体の安定性を損なう主要因となります。

考察 2: スケーリング戦略の必要性

1,000端末を効率的に管理し、処理負荷を軽減するためには、プローブの仕組みを最適化し、すべての端末がすべてのプローブを受信する状況を回避する必要があります。

階層化 (Hierarchical Topology): ネットワークを数十〜数百のグループに分割し、プローブパケットをローカルグループ内でのみマルチキャストします。グループ間の通信は、選出された少数のノード（親ノード/ゲートウェイノード）を介したユニキャストに限定します。

ユニキャスト利用: プローブパケットの送信先を、隣接ノード、既存の親ノード、または候補ノードなど、トポロジー形成に必要なノードのみに限定し、マルチキャストを廃止することで、各端末の受信負荷を大幅に削減できます。

まとめ

IPv6環境においても、プローブパケットの帯域幅総負荷（約 227.2 Kbps）は極めて低いため、ネットワークインフラ上の問題は発生しません。

しかし、1,000端末規模でのトポロジー管理を安定稼働させるには、プローブパケットの受信と処理によるノードごとのCPU負荷を軽減するための階層的なトポロジー設計またはユニキャストベースのプローブ戦略が必須となります。
