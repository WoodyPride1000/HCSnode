HCS (Hybrid Communication System) トポロジー管理層 設計書1. 概要本設計書は、HCSノード間におけるピアディスカバリ、動的な経路選定（親ノード選定）、およびヘルスチェック（障害検出）を担うトポロジーマネージャ (TopologyManager) の構造とロジックを定義する。このマネージャの目的は、ノードが属するグループごとに、最も品質の高い（ハイブリッドな）経路を持つ親ノードを継続的に特定し、通信障害発生時には迅速なフェイルオーバー（経路切り替え）を可能にすることである。2. データ構造の定義トポロジーマネージャが内部で利用する主要な構造体を定義する。2.1. NodeMetrics (ノードメトリクス)ノードの通信品質を評価するための基礎データ。複数の異なる視点からの評価値を統合する。QoS環境下での誤差を吸収するため、RTTを制御プレーンとアプリケーションプレーンで分離する。| フィールド名 | 型 | 説明 | 評価基準 || hop_count | int | 親ノードまでのホップ数 | 少ない方が良い (経路の短さ) || bandwidth_score | int | 帯域幅の品質スコア | 高い方が良い (キャパシティ) || stability_score | int | 安定性/稼働時間のスコア | 高い方が良い (信頼性) || control_rtt_ms | long long | 制御プレーン用RTT (高優先度QoSプローブ) | 低い方が良い (低遅延, 制御通信の応答性) || app_rtt_ms | long long | アプリケーション用RTT (アプリQoSプローブ) | 低い方が良い (低遅延, メディア通信の応答性) |2.2. PeerState (近隣ノードの状態)近隣ノードごとの現在の状態を保持する。| フィールド名 | 型 | 説明 || metrics | NodeMetrics | 最後に受信したノードメトリクス || ip_address | std::string | ノードのIPアドレス || last_advertise_time | time_point | 最終的に ADVERTISE または HEARTBEAT を受信した時刻 || score | double | 最後に計算された総合ノードスコア || is_parent | bool | このノードが現在、自身の親ノードとして選ばれているか || groups | std::set<std::string> | ノードが属するグループIDの集合 |2.3. AdvertiseMessage (状態通知メッセージ)ピアディスカバリおよび状態交換に使用されるメッセージ構造体。| フィールド名 | 型 | 説明 || ip | std::string | 送信元IPアドレス || metrics | NodeMetrics | 送信元ノードの最新メトリクス || groups | std::set<std::string> | 送信元ノードが属するグループID |3. TopologyManager の主要機能とロジック3.1. スコア計算ロジック (ComputeNodeScore)複数のメトリクスを統合し、ノードの総合的な「優秀さ」を評価するハイブリッドなスコア。スコアが高いほど、そのノードは親として適していると判断される。RTTを制御用とアプリ用で分離し、よりきめ細かく品質を評価する。更新された計算式（定数調整可能）:$$\text{Score} = 1000.0 - (\text{hop\_count} \times 10.0) + (\text{bandwidth\_score} \times 5.0) + (\text{stability\_score} \times 2.0) - (\text{control\_rtt\_ms} \times 0.1) - (\text{app\_rtt\_ms} \times 0.05)$$特殊なペナルティ: 1.  制御RTT (control_rtt_ms) が 1000ms を超える場合、制御経路の深刻な障害とみなし、スコアから一律 $500.0$ を減点する。2.  アプリRTT (app_rtt_ms) が 1000ms を超える場合、メディア通信の品質低下とみなし、スコアから一律 $100.0$ を減点する。3.2. 広告メッセージ処理 (HandleAdvertise)ADVERTISEメッセージを受信するたびに以下の処理を行う。PeerStateの更新: 送信元ノードのIPアドレスをキーとして、neighbor_nodes_ マップ内の PeerState を更新する（メトリクス、最終受信時刻、グループ情報）。スコア計算と最良ノード更新:ノードが所属する各グループID (gid) について、ComputeNodeScore を実行。計算されたスコアが、現在の best_scores_[gid] のスコアより高い場合、最良親ノード (parent_ip) をこのノードの IP アドレスに更新する。3.3. 親ノードのヘルスチェック (CheckParentHealth)定期的に実行され、現在選定されている親ノードの生存状態を監視する。最終受信時刻の確認: 現在の親ノードの last_advertise_time を参照する。タイムアウト判定: 現在時刻と最終受信時刻の差が failover_timeout_sec_ (デフォルト: 5秒) を超えた場合、ノードはダウンしたと判定する。フェイルオーバー処理:ダウンしたノードの is_parent フラグをリセット。best_scores_ マップから該当グループのスコア情報を削除し、再選定を強制する。TODO: HCSNode 本体に対して親ノード変更の必要性を通知するコールバックを呼び出し、新しい親ノードの探索と接続を促す。4. 内部管理データ4.1. neighbor_nodes_| 型 | std::map<std::string, PeerState> || キー | 近隣ノードの IP アドレス || 値 | PeerState (近隣ノードの現在の詳細な状態) |4.2. best_scores_| 型 | std::map<std::string, BestScore> || キー | グループ ID || 値 | BestScore (そのグループIDに対する現在の最良スコアと対応する親ノードIP) |4.3. failover_timeout_sec_| 型 | int || 説明 | 親ノードからの通信が途絶した場合に、障害と判定するまでの秒数。デフォルトは 5 秒。 |
