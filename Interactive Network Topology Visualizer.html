<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCS Topology Manager Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Technical Slate & Electric Blue -->
    <!-- Application Structure Plan: 
         1. Header: System Identity and Navigation.
         2. Interactive Topology Visualizer: A custom HTML5 Canvas implementation to visualize Node Relationships, Parent Selection, and Groups (Section 1 & 2). Allows Dragging and Clicking.
         3. Score Algorithm Lab: An interactive section to simulate the ComputeNodeScore logic (Section 3.1), visualizing the impact of Control RTT vs App RTT penalties using Chart.js.
         4. Logic & Data Reference: Structured cards detailing NodeMetrics, PeerState, and Operational Logic (Section 3.2, 3.3).
    -->
    <!-- Visualization & Content Choices: 
         - Topology Map: Canvas is used for high-performance rendering of network nodes. It clarifies the "Parent vs Candidate" relationship visually.
         - Scoring Chart: Chart.js Bar chart helps users visualize the "Weighting" of different metrics (e.g., BW vs RTT) defined in the math formula.
         - Metrics Panel: Uses progress bars to visualize raw metric values against their theoretical maxes.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
            color: #0f172a; /* Slate 900 */
        }
        h1, h2, h3, h4 {
            letter-spacing: -0.025em;
        }
        code, .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Chart Container Styling Rules */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            max-height: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Custom Canvas Cursor */
        canvas#topologyCanvas {
            cursor: default;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Scrollbar for panels */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 backdrop-blur-md bg-opacity-90">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold shadow-lg shadow-blue-600/30">H</div>
                <div>
                    <h1 class="font-bold text-sm leading-tight">HCS Topology Manager</h1>
                    <p class="text-[10px] text-slate-500 font-mono uppercase">Hybrid Communication System</p>
                </div>
            </div>
            <div class="hidden md:flex gap-6 text-sm font-medium text-slate-600">
                <a href="#topology" class="hover:text-blue-600 transition">Network Map</a>
                <a href="#scoring" class="hover:text-blue-600 transition">Scoring Algorithm</a>
                <a href="#specs" class="hover:text-blue-600 transition">Specs & Logic</a>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8 space-y-12">

        <!-- Intro -->
        <section class="text-center max-w-3xl mx-auto mb-12">
            <h2 class="text-3xl font-bold mb-4 text-slate-900">自律分散トポロジー制御</h2>
            <p class="text-slate-600 leading-relaxed">
                HCSにおけるノード間の最適な経路選定と障害検知を可視化するダッシュボードです。
                <span class="font-semibold text-blue-600">制御プレーン</span>と<span class="font-semibold text-orange-500">アプリケーションプレーン</span>のRTTを分離し、QoS環境下でも正確な親ノード選定を実現します。
            </p>
        </section>

        <!-- 1. Interactive Topology Visualizer -->
        <!-- Context: Implements the concepts from Section 1 and 2.2 (PeerState). -->
        <section id="topology" class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="border-b border-slate-100 p-6 flex flex-col md:flex-row justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Network Topology Visualizer</h3>
                    <p class="text-xs text-slate-500 mt-1">Drag nodes to rearrange. Click nodes to inspect metrics.</p>
                </div>
                <div class="flex gap-4 mt-4 md:mt-0 text-xs font-medium">
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-600"></span> Self (Me)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> Parent Node</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-400"></span> Candidate</div>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row h-[650px]">
                <!-- Canvas -->
                <div class="relative w-full lg:w-2/3 h-full bg-slate-100">
                    <canvas id="topologyCanvas" class="w-full h-full block"></canvas>
                    <div class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-2 rounded border border-slate-200 shadow-sm text-xs text-slate-600 font-mono">
                        Nodes: 5<br>Active Parent: Node B
                    </div>
                </div>

                <!-- Detail Panel -->
                <div class="w-full lg:w-1/3 bg-white border-l border-slate-200 p-6 overflow-y-auto custom-scroll">
                    <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-400 text-center opacity-60">
                        <div class="w-16 h-16 mb-4 rounded-full bg-slate-100 flex items-center justify-center">
                            <span class="text-2xl">⚡</span>
                        </div>
                        <p class="text-sm font-medium">Select a node to view details</p>
                    </div>

                    <div id="detailContent" class="hidden space-y-6">
                        <!-- Header -->
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Peer State</span>
                                <span id="nodeRoleBadge" class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide bg-slate-100 text-slate-600">Candidate</span>
                            </div>
                            <h2 id="nodeIp" class="text-2xl font-bold text-slate-800 font-mono">192.168.1.X</h2>
                            <p class="text-xs text-slate-500 mt-1">Group: <span id="nodeGroup" class="font-mono text-slate-700">Public</span></p>
                        </div>

                        <!-- Total Score -->
                        <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl text-center">
                            <div class="text-xs text-blue-600 font-semibold mb-1">COMPUTED SCORE</div>
                            <div id="nodeScore" class="text-4xl font-bold text-blue-700">--</div>
                        </div>

                        <!-- Metrics Breakdown -->
                        <div class="space-y-4">
                            <h4 class="text-sm font-bold text-slate-700 border-b border-slate-100 pb-2">NodeMetrics Breakdown</h4>
                            
                            <!-- Metric Item -->
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-600">Hop Count (Lower is better)</span>
                                    <span id="valHop" class="font-mono font-bold">0</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="barHop" class="h-full bg-red-400" style="width: 0%"></div>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-600">Bandwidth Score (Higher is better)</span>
                                    <span id="valBw" class="font-mono font-bold">0</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="barBw" class="h-full bg-blue-500" style="width: 0%"></div>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-600">Stability Score (Higher is better)</span>
                                    <span id="valStab" class="font-mono font-bold">0</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="barStab" class="h-full bg-emerald-500" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Split RTTs -->
                            <div class="pt-2 border-t border-dashed border-slate-200">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-600 flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full bg-rose-500"></span> Control RTT
                                    </span>
                                    <span id="valCRtt" class="font-mono font-bold">0 ms</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="barCRtt" class="h-full bg-rose-500" style="width: 0%"></div>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-600 flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full bg-orange-400"></span> App RTT
                                    </span>
                                    <span id="valARtt" class="font-mono font-bold">0 ms</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="barARtt" class="h-full bg-orange-400" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-[10px] text-slate-400 text-right pt-4">
                            Last Advertise: <span id="valLastAdv" class="font-mono">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Scoring Algorithm Laboratory -->
        <!-- Context: Implements the formula in Section 3.1, visualizing the penalty logic. -->
        <section id="scoring" class="grid lg:grid-cols-12 gap-8">
            
            <!-- Formula & Controls -->
            <div class="lg:col-span-5 space-y-6">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800">3.1. Algorithm Lab</h3>
                    <p class="text-sm text-slate-500 mt-2">
                        スコア計算ロジックのシミュレーションです。QoS環境下での誤差を吸収するため、RTTを制御用とアプリ用で分離しています。
                    </p>
                </div>

                <div class="bg-slate-800 text-slate-200 p-4 rounded-lg font-mono text-xs leading-relaxed overflow-x-auto">
                    Score = 1000 
                    <span class="text-red-400">- (Hop * 10)</span>
                    <span class="text-blue-400">+ (BW * 5)</span>
                    <span class="text-emerald-400">+ (Stab * 2)</span>
                    <br>
                    <span class="text-rose-400 pl-12">- (C_RTT * 0.1)</span>
                    <span class="text-orange-400">- (A_RTT * 0.05)</span>
                </div>

                <!-- Sliders -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 space-y-5">
                    <!-- Hop -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                            <span>Hop Count</span>
                            <span id="lblHop">2</span>
                        </div>
                        <input type="range" id="inHop" min="0" max="20" value="2" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-500">
                    </div>
                    <!-- BW -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                            <span>Bandwidth Score</span>
                            <span id="lblBw">80</span>
                        </div>
                        <input type="range" id="inBw" min="0" max="100" value="80" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>
                    <!-- Stability -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                            <span>Stability Score</span>
                            <span id="lblStab">90</span>
                        </div>
                        <input type="range" id="inStab" min="0" max="100" value="90" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                    </div>
                    <!-- Control RTT -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 bg-rose-500 rounded-full"></span> Control RTT (ms)</span>
                            <span id="lblCRtt">50</span>
                        </div>
                        <input type="range" id="inCRtt" min="0" max="1500" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-rose-500">
                        <p class="text-[10px] text-slate-400 mt-1">>1000ms triggers -500 penalty</p>
                    </div>
                    <!-- App RTT -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-slate-600 mb-2">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 bg-orange-400 rounded-full"></span> App RTT (ms)</span>
                            <span id="lblARtt">50</span>
                        </div>
                        <input type="range" id="inARtt" min="0" max="1500" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                         <p class="text-[10px] text-slate-400 mt-1">>1000ms triggers -100 penalty</p>
                    </div>
                </div>
            </div>

            <!-- Real-time Chart -->
            <div class="lg:col-span-7 flex flex-col">
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 flex-grow flex flex-col items-center justify-center">
                    <div class="w-full text-center mb-6">
                        <div class="text-sm text-slate-500 font-semibold tracking-wider uppercase">Total Score</div>
                        <div id="calcScore" class="text-6xl font-black text-slate-800 tracking-tighter">--</div>
                        <div class="h-6 mt-2 flex gap-2 justify-center">
                            <span id="badgeCPenalty" class="hidden px-2 py-0.5 bg-red-100 text-red-700 text-[10px] font-bold rounded uppercase tracking-wide border border-red-200">Critical Control Lag</span>
                            <span id="badgeAPenalty" class="hidden px-2 py-0.5 bg-orange-100 text-orange-700 text-[10px] font-bold rounded uppercase tracking-wide border border-orange-200">App Lag</span>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Specs & Logic Reference -->
        <section id="specs" class="grid md:grid-cols-3 gap-6">
            <!-- PeerState Card -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                <div class="w-10 h-10 bg-indigo-50 rounded-lg flex items-center justify-center mb-4 text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
                <h4 class="font-bold text-slate-800 mb-2">PeerState</h4>
                <p class="text-xs text-slate-500 mb-4">Local cache of neighbor node status.</p>
                <ul class="text-xs space-y-2 text-slate-700 font-mono">
                    <li class="flex justify-between border-b border-slate-100 pb-1"><span>metrics</span> <span class="text-slate-400">NodeMetrics</span></li>
                    <li class="flex justify-between border-b border-slate-100 pb-1"><span>score</span> <span class="text-slate-400">double</span></li>
                    <li class="flex justify-between border-b border-slate-100 pb-1"><span>is_parent</span> <span class="text-slate-400">bool</span></li>
                    <li class="flex justify-between"><span>last_adv_time</span> <span class="text-slate-400">time_point</span></li>
                </ul>
            </div>

            <!-- HandleAdvertise Card -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                <div class="w-10 h-10 bg-emerald-50 rounded-lg flex items-center justify-center mb-4 text-emerald-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                </div>
                <h4 class="font-bold text-slate-800 mb-2">HandleAdvertise</h4>
                <p class="text-xs text-slate-500 mb-4">Triggered upon receiving multicast advertisement.</p>
                <ol class="text-xs space-y-2 text-slate-700 list-decimal list-inside">
                    <li>Update <code class="bg-slate-100 px-1 rounded">neighbor_nodes_</code> map.</li>
                    <li>Calculate Score for each group.</li>
                    <li>If <code class="bg-slate-100 px-1 rounded">new_score > current_best</code>, update <code class="bg-slate-100 px-1 rounded">best_scores_</code>.</li>
                    <li>Trigger parent switch if necessary.</li>
                </ol>
            </div>

            <!-- HealthCheck Card -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                <div class="w-10 h-10 bg-rose-50 rounded-lg flex items-center justify-center mb-4 text-rose-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h4 class="font-bold text-slate-800 mb-2">CheckParentHealth</h4>
                <p class="text-xs text-slate-500 mb-4">Periodic failover protection mechanism.</p>
                <div class="text-xs bg-slate-50 p-2 rounded border border-slate-100 font-mono text-slate-600">
                    elapsed = now - last_adv;<br>
                    if (elapsed > 5s) {<br>
                    &nbsp;&nbsp;is_parent = false;<br>
                    &nbsp;&nbsp;TriggerFailover();<br>
                    }
                </div>
            </div>
        </section>

    </main>

    <!-- JavaScript Implementation -->
    <script>
        // ==========================================
        // 1. Topology Visualizer Logic (Canvas)
        // ==========================================
        const canvas = document.getElementById('topologyCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let selectedNodeId = null;

        // Drag State
        let isDragging = false;
        let dragNode = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let mouseDownPos = null; // For click tolerance
        const CLICK_TOLERANCE = 5;

        // Mock Data
        const nodes = [
            { id: 0, x: 0, y: 0, label: "Me", ip: "127.0.0.1", type: "self", metrics: { hop: 0, bw: 0, stab: 0, crtt: 0, artt: 0 } },
            { id: 1, x: 0, y: -150, label: "Parent A", ip: "192.168.1.50", type: "parent", metrics: { hop: 1, bw: 95, stab: 98, crtt: 5, artt: 10 } },
            { id: 2, x: -120, y: -220, label: "Cand B", ip: "192.168.1.51", type: "candidate", metrics: { hop: 2, bw: 80, stab: 90, crtt: 15, artt: 40 } },
            { id: 3, x: 120, y: -220, label: "Cand C", ip: "192.168.1.52", type: "candidate", metrics: { hop: 2, bw: 60, stab: 85, crtt: 40, artt: 60 } },
            { id: 4, x: -180, y: -80, label: "Cand D (Lag)", ip: "192.168.1.53", type: "candidate", metrics: { hop: 3, bw: 40, stab: 50, crtt: 1200, artt: 1500 } },
        ];

        const links = [
            { from: 0, to: 1 }, // Connected
            { from: 1, to: 2 },
            { from: 1, to: 3 },
            { from: 2, to: 4 }
        ];

        // Shared Logic: Calculate Score
        function calcScore(m) {
            let s = 1000 - (m.hop * 10) + (m.bw * 5) + (m.stab * 2);
            s -= (m.crtt * 0.1);
            if(m.crtt > 1000) s -= 500;
            s -= (m.artt * 0.05);
            if(m.artt > 1000) s -= 100;
            return Math.floor(s * 10) / 10;
        }

        // Pre-calculate scores
        nodes.forEach(n => { if(n.type !== 'self') n.score = calcScore(n.metrics); });

        // Canvas Resize
        function resize() {
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            width = canvas.width;
            height = canvas.height;
            draw();
        }
        window.addEventListener('resize', resize);

        // Draw Frame
        function draw() {
            ctx.clearRect(0, 0, width, height);
            const cx = width / 2;
            const cy = height / 2;

            // Draw Links
            ctx.lineWidth = 2;
            links.forEach(l => {
                const n1 = nodes.find(n => n.id === l.from);
                const n2 = nodes.find(n => n.id === l.to);
                
                ctx.strokeStyle = (n1.type === 'self' && n2.type === 'parent') ? '#10b981' : '#cbd5e1';
                if (n1.type === 'self' && n2.type === 'parent') ctx.lineWidth = 3; else ctx.lineWidth = 1.5;

                ctx.beginPath();
                ctx.moveTo(cx + n1.x, cy + n1.y);
                ctx.lineTo(cx + n2.x, cy + n2.y);
                ctx.stroke();
            });

            // Draw Nodes
            nodes.forEach(n => {
                const nx = cx + n.x;
                const ny = cy + n.y;
                n._gx = nx; n._gy = ny; // Store global coords

                // Highlight selection
                if (selectedNodeId === n.id) {
                    ctx.beginPath();
                    ctx.arc(nx, ny, 28, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(37, 99, 235, 0.15)';
                    ctx.fill();
                }

                // Node Body
                ctx.beginPath();
                ctx.arc(nx, ny, 20, 0, Math.PI*2);
                
                if (n.type === 'self') ctx.fillStyle = '#2563eb'; // Blue
                else if (n.type === 'parent') ctx.fillStyle = '#10b981'; // Emerald
                else ctx.fillStyle = '#94a3b8'; // Slate

                // Warn color if score is low or penalty active
                if (n.type !== 'self' && (n.metrics.crtt > 1000 || n.metrics.artt > 1000)) {
                    ctx.strokeStyle = '#f43f5e'; // Rose border for lag
                    ctx.lineWidth = 3;
                } else {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3;
                }
                
                ctx.fill();
                ctx.stroke();

                // Label
                ctx.fillStyle = '#0f172a';
                ctx.font = '600 11px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(n.label, nx, ny + 35);
                
                // Score badge
                if(n.type !== 'self') {
                    ctx.fillStyle = '#64748b';
                    ctx.font = '400 10px Inter';
                    ctx.fillText(n.score, nx, ny + 48);
                }
            });
        }

        // Interaction Logic
        canvas.addEventListener('mousedown', e => {
            const r = canvas.getBoundingClientRect();
            const mx = e.clientX - r.left;
            const my = e.clientY - r.top;
            mouseDownPos = { x: mx, y: my };

            nodes.forEach(n => {
                const dist = Math.hypot(mx - n._gx, my - n._gy);
                if (dist < 25) {
                    isDragging = true;
                    dragNode = n;
                    dragOffsetX = mx - n.x; // Store relative offset to node local coord
                    dragOffsetY = my - n.y;
                    canvas.style.cursor = 'grabbing';
                }
            });
        });

        canvas.addEventListener('mousemove', e => {
            const r = canvas.getBoundingClientRect();
            const mx = e.clientX - r.left;
            const my = e.clientY - r.top;

            if (isDragging && dragNode) {
                // Update position
                // dragOffset already accounts for cx/cy shift if we calc correctly, 
                // but simplest is: localX = mouseX - canvasCenter - internalOffset
                const cx = width / 2;
                const cy = height / 2;
                // We stored offset as (MouseGlobal - NodeLocal). 
                // Actually simpler: local = MouseGlobal - Center - (MouseGlobalStart - NodeStartGlobal)... 
                // Let's use simple delta approach or direct mapping:
                // dragOffsetX was (mx - n.x). So n.x = mx - dragOffsetX is wrong because mx is global.
                // Correct: dragOffsetX = mx (global) - n._gx (global) [pixel offset from center of node]
                // Wait, simpler: n.x = (mx - cx) - (click_offset_from_node_center)
                
                // Let's re-calc offset on mousedown to be offset from node center
                // Redo mousedown logic conceptually in head:
                // dragOffsetX = mx - n._gx;
                // dragOffsetY = my - n._gy;
                // In move: n.x = (mx - cx) - dragOffsetX;
                
                // Correction for implementation below:
                dragNode.x = (mx - width/2); // Snap center for simplicity or implement offset
                dragNode.y = (my - height/2);
                draw();
            } else {
                // Hover effect
                let hit = false;
                nodes.forEach(n => {
                    const dist = Math.hypot(mx - n._gx, my - n._gy);
                    if (dist < 25) hit = true;
                });
                canvas.style.cursor = hit ? 'grab' : 'default';
            }
        });

        canvas.addEventListener('mouseup', e => {
            const r = canvas.getBoundingClientRect();
            const upX = e.clientX - r.left;
            const upY = e.clientY - r.top;

            if (mouseDownPos) {
                const dist = Math.hypot(upX - mouseDownPos.x, upY - mouseDownPos.y);
                if (dist < CLICK_TOLERANCE) {
                    // It's a click
                    let clickedNode = null;
                    nodes.forEach(n => {
                        const d = Math.hypot(upX - n._gx, upY - n._gy);
                        if (d < 25) clickedNode = n;
                    });
                    if (clickedNode && clickedNode.type !== 'self') {
                        selectedNodeId = clickedNode.id;
                        renderDetails(clickedNode);
                        draw();
                    }
                }
            }

            isDragging = false;
            dragNode = null;
            canvas.style.cursor = 'default';
        });

        function renderDetails(node) {
            const p = document.getElementById('emptyState');
            const c = document.getElementById('detailContent');
            p.classList.add('hidden');
            c.classList.remove('hidden');

            // Fill Data
            document.getElementById('nodeIp').innerText = node.ip;
            const roleBadge = document.getElementById('nodeRoleBadge');
            roleBadge.innerText = node.type === 'parent' ? 'Parent Node' : 'Candidate';
            roleBadge.className = node.type === 'parent' 
                ? "px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide bg-emerald-100 text-emerald-700"
                : "px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide bg-slate-100 text-slate-600";
            
            document.getElementById('nodeScore').innerText = node.score;

            // Bars
            setBar('valHop', 'barHop', node.metrics.hop, 10);
            setBar('valBw', 'barBw', node.metrics.bw, 100);
            setBar('valStab', 'barStab', node.metrics.stab, 100);
            setBar('valCRtt', 'barCRtt', node.metrics.crtt, 1500);
            setBar('valARtt', 'barARtt', node.metrics.artt, 1500);

            document.getElementById('valLastAdv').innerText = new Date().toLocaleTimeString();
        }

        function setBar(txtId, barId, val, max) {
            document.getElementById(txtId).innerText = val;
            const pct = Math.min(100, (val / max) * 100);
            document.getElementById(barId).style.width = `${pct}%`;
        }

        // Init
        resize();


        // ==========================================
        // 2. Algorithm Lab Logic
        // ==========================================
        const sliders = {
            hop: document.getElementById('inHop'),
            bw: document.getElementById('inBw'),
            stab: document.getElementById('inStab'),
            crtt: document.getElementById('inCRtt'),
            artt: document.getElementById('inARtt'),
        };

        const displays = {
            hop: document.getElementById('lblHop'),
            bw: document.getElementById('lblBw'),
            stab: document.getElementById('lblStab'),
            crtt: document.getElementById('lblCRtt'),
            artt: document.getElementById('lblARtt'),
            score: document.getElementById('calcScore'),
            penC: document.getElementById('badgeCPenalty'),
            penA: document.getElementById('badgeAPenalty'),
        };

        const ctxChart = document.getElementById('scoreChart').getContext('2d');
        const algoChart = new Chart(ctxChart, {
            type: 'bar',
            data: {
                labels: ['Base', 'Hop (-)', 'BW (+)', 'Stab (+)', 'C-RTT (-)', 'A-RTT (-)'],
                datasets: [{
                    data: [0,0,0,0,0,0],
                    backgroundColor: ['#94a3b8', '#f43f5e', '#3b82f6', '#10b981', '#e11d48', '#f97316'],
                    borderRadius: 4,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });

        function updateCalc() {
            const vals = {
                hop: parseInt(sliders.hop.value),
                bw: parseInt(sliders.bw.value),
                stab: parseInt(sliders.stab.value),
                crtt: parseInt(sliders.crtt.value),
                artt: parseInt(sliders.artt.value),
            };

            // Update labels
            displays.hop.innerText = vals.hop;
            displays.bw.innerText = vals.bw;
            displays.stab.innerText = vals.stab;
            displays.crtt.innerText = vals.crtt;
            displays.artt.innerText = vals.artt;

            // Formula
            const base = 1000;
            const cHop = vals.hop * 10;
            const cBw = vals.bw * 5;
            const cStab = vals.stab * 2;
            const cCrtt = vals.crtt * 0.1;
            const cArtt = vals.artt * 0.05;

            let total = base - cHop + cBw + cStab - cCrtt - cArtt;

            // Penalties
            let penC = 0, penA = 0;
            if(vals.crtt > 1000) { penC = 500; total -= 500; displays.penC.classList.remove('hidden'); }
            else displays.penC.classList.add('hidden');

            if(vals.artt > 1000) { penA = 100; total -= 100; displays.penA.classList.remove('hidden'); }
            else displays.penA.classList.add('hidden');

            displays.score.innerText = total.toFixed(1);

            // Update Chart
            algoChart.data.datasets[0].data = [
                base, 
                -cHop, 
                cBw, 
                cStab, 
                -(cCrtt + penC), 
                -(cArtt + penA)
            ];
            algoChart.update();
        }

        Object.values(sliders).forEach(s => s.addEventListener('input', updateCalc));
        updateCalc();

    </script>
</body>
</html>
